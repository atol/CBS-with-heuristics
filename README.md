# Benchmarking Heuristics for Conflict-Based Search

For this project, we implemented ICBS and ICBS-h (the CG heuristic) and compared their performance to CBS. 
We evaluated runtime, memory usage, the number of nodes expanded and the number of nodes generated by
each algorithm across different instances of MAPF problems.

## Introduction

Multi-Agent Path Finding (MAPF) is the problem of finding a set of collision-free paths for a
given set of agents. A MAPF problem is defined by a graph `G = (V , E)` and a set of `k` agents.
Each agent has a start position `s` and a goal position `g`. At each discrete timestep, 
an agent can either move to an adjacent location or wait in its current location. Moving or waiting 
incurs a cost of `1`, unless the agent is waiting at its goal location.

A **path** for an agent is a sequence of actions that leads the agent from its start location `s` to its
goal location `g`. 

A **vertex conflict** is a tuple `(a1, a2, v, t)` where agents `a1` and `a2` occupy the same
vertex `v` at timestep `t`.

An **edge conflict** is a tuple `(a1, a2, u, v, t)` where agents `a1` and `a2` traverse 
the same edge `(u, v)` in opposite directions between timesteps `t` and `t + 1`.

The task is to find a set of conflict-free paths that minimizes the sum of the costs for these paths.

## Requirements

Create a virtual environment (recommended):

```
python3 -m venv venv
source venv/bin/activate
```

Install requirements:

```
pip install -r requirements.txt
```

## Usage

To solve a particular MAPF instance, run:

```
python3 run_experiments.py --instance instances/test_1.txt --solver CBS
```

Use the `--solver` option to change the type of solver to `ICBS` for ICBS or `Conflict` for the CG heuristic.

To solve a batch of MAPF instances, run:

```
python3 run_experiments.py --instance "instances/test_*" --solver CBS --batch
```

The `batch` command creates an output file `results.csv` with the runtime, memory usage, sum of solution cost,
number of expanded nodes and number of generated nodes for each solved instance.

## CBS

Conflict-Based Search (CBS) is an algorithm that guarantees optimal solutions to MAPF
problems. At the high-level, CBS searches a binary constraint tree (CT) in a best-first manner, 
where the nodes are ordered according to their solution costs. Given a CT node, the low-level of CBS 
finds an optimal path for each agent that satisfies its constraints.

## Improved CBS

The CBS algorithm splits CT nodes at the high-level by arbitrarily selecting a conflict (e.g. the
first conflict) within the current set of paths. Poor choices can increase the size of the CT tree
and its runtime by continuing to explore an area with similar cost.

ICBS remedies this by introducing the idea of cardinal, semi-cardinal and non-cardinal conflicts. 
Splitting on cardinal conflicts first can reduce the size of the CT search tree, especially in 
dense environments with many bottlenecks.

A conflict is **cardinal** for a CT node `N` if splitting `N` results in two child
nodes both having a cost greater than `N.cost`.

A conflict is **semi-cardinal** if one of the child nodes has a cost greater than `N.cost` while the 
other has a cost equal to `N.cost`. 

A conflict is **non-cardinal** if both children have costs equal to `N.cost`.

## CG Heuristic

ICBS-h improves on ICBS by using an admissible heuristic to select a CT node `N` for
expansion in the high-level search. The `h-value` is determined from `N`'s cardinal conflicts.

We first construct a conflict graph `G = (V, E)` of `N`. Each vertex `v` represents an agent that
is involved in at least one cardinal conflict. Each edge `(u, v)` represents a cardinal
conflict between two agents.

If `N` contains only one cardinal conflict, then the `h-value` is `1`.

If `N` contains multiple cardinal conflicts, then we can use the size of a minimum vertex cover
of the conflict graph as the `h-value`.

## References

[1] G. Sharon, R. Stern, A. Felner, and N. R. Sturtevant, "Conflict-based search for optimal
multi-agent pathfinding," *Artificial Intelligence*, vol. 219, pp. 40-66, 2015.

[2] J. Li, A. Felner, E. Boyarski, H. Ma, and S. Koenig, "Improved Heuristics for Multi-Agent
Path Finding with Conflict-Based Search," in Proceedings of the Twenty-Eighth International
Joint Conference on *Artificial Intelligence*, 442-449, 2019.

[3] E. Boyarski, A. Felner, R. Stern, G. Sharon, D. Tolpin, O. Betzalel, and S. Shimony,
"ICBS: Improved conflict-based search algorithm for multi-agent pathfinding," in *Proceedings
of the International Joint Conference on Artificial Intelligence*, 740–746, 2015.

[4] A. Felner, J. Li, E. Boyarski, H. Ma, L. Cohen, T.K. Kumar, and S. Koenig, "Adding
Heuristics to Conflict-Based Search for Multi-Agent Path Finding," *ICAPS*, 2018.

[5] G. Sharon, R. Stern, M. Goldenberg, A. Felner, "The Increasing Cost Tree Search for
Optimal Multi-Agent Pathfinding," in *Proceedings of the Twenty-Second International Joint
Conference on Artificial Intelligence*, 662-667, 2013.

[6] R.G. Downey and M.R. Fellows, "Parameterized Computational Feasibility," in *Feasible
Mathematics II*, vol 13, P. Clote P. and J.B. Remmel, Eds. Boston: Birkhäuser Boston,
219–244, 1995.
